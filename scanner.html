<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scanner 16</title>
<style>
  :root{
    --bg:#ffffff; --ink:#0f172a; --muted:#64748b;
    --border:#e5e7eb; --accent:#2563eb; --accent-2:#1e40af;
    --shadow:0 10px 30px rgba(2,6,23,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
  .container{max-width:800px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:16px}
  .card{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
  .hero{
    display:flex;align-items:center;gap:14px
  }
  .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#e2e8f0,#ffffff);display:flex;align-items:center;justify-content:center;border:1px solid var(--border)}
  .logo span{font-size:22px}
  h1{font-size:1.35rem;line-height:1.2;margin:0}
  .sub{color:var(--muted);font-size:.96rem;margin-top:2px}
  label{font-size:.9rem;color:var(--muted)}
  select,button,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);font-size:1rem;background:#fff;color:var(--ink)}
  textarea{min-height:100px;resize:vertical}
  .row{display:grid;gap:10px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:720px){ .grid2{grid-template-columns:1fr} }
  .btn{cursor:pointer;font-weight:700}
  .btn:active{transform:translateY(1px)}
  .btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn-primary:hover{background:var(--accent-2)}
  .btn-ghost{background:#f8fafc}
  video{width:100%;aspect-ratio:16/9;background:#000;border-radius:14px;border:1px solid var(--border)}
  .meta{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .badge{padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:.85rem;background:#f8fafc}
  .mono{font-family:ui-monospace,Consolas,monospace}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="hero">
      <div class="logo"><span>üì∑</span></div>
      <div>
        <h1>Scanner 16</h1>
        <div class="sub">Accetta <b>solo blocchi da 16</b> (alfanumerici, maiuscoli). Se il codice √® un multiplo di 16, lo spezza in blocchi.</div>
      </div>
    </div>
    <div class="grid2" style="margin-top:14px">
      <div class="row">
        <label for="cameraSel">Fotocamera</label>
        <select id="cameraSel" aria-label="Seleziona fotocamera"></select>
      </div>
      <div class="row">
        <label>&nbsp;</label>
        <div class="grid2">
          <button id="btnStart" class="btn btn-primary">Avvia</button>
          <button id="btnStop" class="btn btn-ghost">Stop</button>
        </div>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <video id="preview" playsinline muted></video>
      <div class="meta">
        <div class="badge">Stato: <span id="status" class="mono">In attesa‚Ä¶</span></div>
        <div class="badge">Ultimo: <span id="last" class="mono">‚Äî</span></div>
        <div class="badge">Totale: <span id="count" class="mono">0</span></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <label>Raccolta (spazio-separati)</label>
      <textarea id="bag" class="mono" placeholder="VUOTO"></textarea>
    </div>
    <div class="grid2" style="margin-top:10px">
      <button id="btnCopy" class="btn btn-ghost">Copia</button>
      <button id="btnClear" class="btn btn-ghost">Svuota</button>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnSend" class="btn btn-primary" style="display:none">Invia al bot</button>
      <div class="sub" id="sendHint">Apri dentro Telegram per inviare direttamente al bot; altrimenti usa ‚ÄúCopia‚Äù.</div>
    </div>
  </div>
</div>

<!-- ZXing UMD (global: ZXing) -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.2/umd/index.min.js"></script>
<script>
  // ===== Config =====
  const CODICE_LEN = 16;
  let scanning = false;
  let devices = [];
  let selectedIndex = 0;

  const reader = new ZXing.BrowserMultiFormatReader(
    new Map([[ZXing.DecodeHintType.POSSIBLE_FORMATS, [
      ZXing.BarcodeFormat.QR_CODE,
      ZXing.BarcodeFormat.DATA_MATRIX,
      ZXing.BarcodeFormat.CODE_128,
      ZXing.BarcodeFormat.CODE_39,
      ZXing.BarcodeFormat.EAN_13,
      ZXing.BarcodeFormat.EAN_8,
      ZXing.BarcodeFormat.ITF,
      ZXing.BarcodeFormat.UPC_A
    ]]]),
    250
  );

  // ===== State =====
  const bag = []; const dedup = new Set();

  // ===== UI refs =====
  const video = document.getElementById('preview');
  const cameraSel = document.getElementById('cameraSel');
  const statusEl = document.getElementById('status');
  const lastEl = document.getElementById('last');
  const countEl = document.getElementById('count');
  const bagEl = document.getElementById('bag');
  const btnStart = document.getElementById('btnStart');
  const btnStop  = document.getElementById('btnStop');
  const btnCopy  = document.getElementById('btnCopy');
  const btnClear = document.getElementById('btnClear');
  const btnSend  = document.getElementById('btnSend');
  const tg = window.Telegram ? window.Telegram.WebApp : null;
  if (tg) { tg.expand(); btnSend.style.display = 'block'; document.getElementById('sendHint').style.display='none'; }

  // ===== Utils =====
  function sanitizeAndSplit(raw){
    if(!raw) return [];
    let s = String(raw).toUpperCase().replace(/[^A-Z0-9]/g,'');
    if (s.length === CODICE_LEN) return [s];
    if (s.length > CODICE_LEN && s.length % CODICE_LEN === 0) {
      const out = [];
      for (let i=0;i<s.length;i+=CODICE_LEN) out.push(s.slice(i,i+CODICE_LEN));
      return out;
    }
    return []; // scarta non multipli di 16
  }
  function renderBag(){ bagEl.value = bag.join(' '); countEl.textContent = String(bag.length); }
  function addCodes(arr){
    let added=0;
    for(const c of arr){
      if (c.length!==CODICE_LEN) continue;
      if(!dedup.has(c)){ dedup.add(c); bag.push(c); added++; }
    }
    if(added>0) renderBag();
    return added;
  }

  // ===== Cameras =====
  async function populateCamerasAfterPermission(){
    try{
      const all = await navigator.mediaDevices.enumerateDevices();
      const cams = all.filter(d => d.kind === 'videoinput');
      if (!cams.length) return;
      devices = cams;
      cameraSel.innerHTML = '';
      cams.forEach((d,i)=>{
        const opt = document.createElement('option');
        opt.value = d.deviceId || '';
        opt.textContent = d.label || `Camera ${i+1}`;
        cameraSel.appendChild(opt);
      });
      // prefer back camera quando possibile
      const backIdx = cams.findIndex(d => /back|rear|post/i.test(d.label||''));
      selectedIndex = backIdx>=0 ? backIdx : 0;
      cameraSel.selectedIndex = selectedIndex;
    }catch(e){}
  }

  async function start(deviceId){
    if (scanning) return;
    scanning = true;
    btnStart.disabled = true;
    statusEl.textContent = 'Apertura camera‚Ä¶';
    try{
      await reader.decodeFromVideoDevice(deviceId || null, video, (result, err) => {
        if (result) {
          const chunks = sanitizeAndSplit(result.getText());
          const added = addCodes(chunks);
          if (added>0) lastEl.textContent = chunks.join(' ');
        }
      });
      // Una volta aperta la camera, popoliamo la select con etichette (evita doppi permessi su mobile)
      if (!devices.length) { await populateCamerasAfterPermission(); }
      statusEl.textContent = 'Scanning...';
    }catch(e){
      statusEl.textContent = 'Camera non disponibile o permesso negato';
      scanning = false; btnStart.disabled = false;
      try{ reader.reset(); }catch(_){}
    }
  }

  function stop(){
    if (!scanning) return;
    scanning = false;
    try{ reader.reset(); }catch(_){}
    statusEl.textContent = 'In attesa‚Ä¶';
    btnStart.disabled = false;
  }

  // ===== Events =====
  btnStart.onclick = ()=> {
    const devId = devices.length ? devices[cameraSel.selectedIndex]?.deviceId : undefined;
    start(devId);
  };
  btnStop.onclick = stop;

  cameraSel.onchange = ()=>{
    if (!devices.length) return;
    selectedIndex = cameraSel.selectedIndex || 0;
    if (scanning) { stop(); const devId = devices[selectedIndex]?.deviceId; start(devId); }
  };

  btnCopy.onclick = async ()=>{
    try{ await navigator.clipboard.writeText(bag.join(' ')); statusEl.textContent = `Copiati ${bag.length} codici`; }
    catch(e){ statusEl.textContent = 'Clipboard non disponibile'; }
  };
  btnClear.onclick = ()=>{ bag.length=0; dedup.clear(); renderBag(); lastEl.textContent='‚Äî'; statusEl.textContent='In attesa‚Ä¶'; };

  btnSend.onclick = ()=>{
    if (tg) { tg.sendData(JSON.stringify({ codes: bag })); tg.close(); }
  };
</script>
</body>
</html>
