<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scanner 16 ‚Äì OpsHub</title>
<style>
  :root{
    --bg:#ffffff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
    --blue:#1e3a8a; --blue-2:#3b82f6; --chip:#eef2ff;
    --glass:rgba(255,255,255,.52); --shadow:0 12px 32px rgba(2,6,23,.18);
    --footer-h:68px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
  body{ padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--footer-h) + 16px); }

  .container{max-width:1060px;margin:0 auto;padding:8px 8px 0}
  .video-wrap{position:relative;border:1px solid var(--border);border-radius:18px;overflow:hidden;box-shadow:0 10px 30px rgba(2,6,23,.06);background:#000}
  video#preview{width:100%;height:82vh;min-height:440px;max-height:88vh;object-fit:cover;display:block;background:#000}

  /* Overlay TOP (super light) */
  .ov{position:absolute;left:50%;transform:translateX(-50%);z-index:10040;display:flex;align-items:center;gap:10px;flex-wrap:wrap;
    background:var(--glass);backdrop-filter:blur(10px) saturate(1.02);border:1px solid rgba(229,231,235,.65);
    border-radius:16px;padding:6px 8px;box-shadow:var(--shadow);width:calc(100% - 16px);max-width:980px}
  .ov.top{top:10px}
  .btn{height:46px;padding:0 14px;border-radius:14px;border:1px solid var(--border);background:#fff;color:#0f172a;font-weight:700;cursor:pointer}
  .btn:hover{background:#f8fafc}.btn:active{transform:translateY(1px)}
  .btn-icon{width:56px;height:56px;padding:0;border-radius:999px;display:flex;align-items:center;justify-content:center;font-size:30px;line-height:1}
  .badge{padding:6px 12px;border-radius:999px;border:1px solid var(--border);background:#f8fafc;font-size:.9rem}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--chip);font-family:ui-monospace,Consolas,monospace;font-size:.9rem}

  /* Drawer Matricole (sopra al video e sopra alla top bar) */
  .drawer{position:absolute;right:12px;bottom:12px;z-index:10050;width:min(380px,calc(100% - 24px));max-height:70vh;display:flex;flex-direction:column;gap:8px;
    background:var(--glass);backdrop-filter:blur(10px) saturate(1.05);border:1px solid rgba(229,231,235,.7);border-radius:16px;box-shadow:var(--shadow);
    overflow:hidden;opacity:0;transform:translateY(8px);pointer-events:none;transition:opacity .16s ease,transform .16s ease}
  .drawer.open{opacity:1;transform:translateY(0);pointer-events:auto}
  .drawer .head{display:flex;align-items:center;gap:10px;padding:8px 10px;background:linear-gradient(135deg,#f8fafc,#fff);border-bottom:1px solid var(--border)}
  .drawer .title{font-weight:700}.drawer .body{padding:8px 10px;overflow:auto}
  .drawer .list{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:6px}
  .drawer .row{display:flex;align-items:center;gap:8px;justify-content:space-between;border:1px solid var(--border);border-radius:12px;background:#fff;padding:6px 8px}
  .drawer .code{font-family:ui-monospace,Consolas,monospace;font-size:.95rem;letter-spacing:.5px}
  .drawer .x{border:none;background:#fee2e2;color:#991b1b;border-radius:10px;padding:6px 8px;cursor:pointer;font-weight:700}
  .drawer .x:hover{filter:brightness(.96)}

  /* Toast (in alto a destra nel video) */
  .toast{position:absolute;right:12px;top:12px;z-index:10060;background:#0ea5e9;color:white;border-radius:12px;padding:8px 12px;box-shadow:var(--shadow);font-weight:700;display:none}
  .toast.show{display:block}

  /* Popup ultima matricola (sopra ai pulsanti, sotto la camera) */
  .lastpop{
    position:fixed; left:50%; transform:translateX(-50%) translateY(10px);
    bottom: calc(env(safe-area-inset-bottom,0px) + var(--footer-h) + 10px);
    z-index:9050;
    background:rgba(255,255,255,.9); backdrop-filter:blur(8px);
    border:1px solid rgba(229,231,235,.9); border-radius:14px; box-shadow:var(--shadow);
    padding:8px 12px; max-width:92%;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    opacity:0; pointer-events:none; transition:opacity .18s ease, transform .18s ease;
    font-size:1rem;
  }
  .lastpop .lp-code{font-family:ui-monospace,Consolas,monospace; letter-spacing:.6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .lastpop .lp-total{padding:4px 10px; border-radius:999px; border:1px solid var(--border); background:var(--chip); font-weight:700; font-size:.9rem; white-space:nowrap}
  .lastpop.show{ opacity:1; transform:translateX(-50%) translateY(0) }

  /* Footer fisso: Svuota | Copia | Invia */
  .footerbar{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:calc(env(safe-area-inset-bottom,0px) + 0px); z-index:9000;
    width:100%; max-width:1060px; height:var(--footer-h);
    padding:8px 10px;
    background:linear-gradient(180deg, rgba(255,255,255,.88), rgba(255,255,255,.98));
    border-top:1px solid rgba(229,231,235,.9);
    box-shadow:0 -8px 20px rgba(2,6,23,.08); backdrop-filter:blur(8px);
    display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; align-items:center;
  }
  .footerbar .btn{height:52px;border-radius:14px;border:1px solid var(--border);background:#fff;font-weight:800}
  .footerbar .btn:hover{background:#f8fafc}
  .footerbar .btn-primary{background:linear-gradient(135deg,var(--blue-2),var(--blue));color:#fff;border-color:transparent;box-shadow:0 8px 18px rgba(30,58,138,.28)}
  .footerbar .left{justify-self:start;width:100%}
  .footerbar .center{justify-self:center;width:100%}
  .footerbar .right{justify-self:end;width:100%}

  @media (max-width:760px){
    video#preview{height:78vh;min-height:360px}
    .btn-icon{width:52px;height:52px;font-size:28px}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="video-wrap">
      <video id="preview" playsinline muted></video>

      <!-- Overlay TOP (solo comandi rapidi) -->
      <div class="ov top" id="ovTop">
        <button id="flip"  class="btn btn-icon" title="Cambia camera">‚Ü∫</button>
        <button id="torch" class="btn btn-icon" title="Torcia">üî¶</button>
        <div style="flex:1"></div>
        <button id="openDrawerTop" class="btn btn-icon" title="Matricole">‚â£</button>
      </div>

      <!-- Drawer Matricole -->
      <div class="drawer" id="drawer">
        <div class="head">
          <div class="title">Matricole lette</div>
          <div style="flex:1"></div>
          <button id="closeDrawer" class="btn btn-icon" title="Chiudi">‚úï</button>
        </div>
        <div class="body"><ul class="list" id="codeList"></ul></div>
      </div>

      <!-- Toast -->
      <div class="toast" id="toast">Pronto</div>
    </div>
  </div>

  <!-- Popup ultima matricola + totale -->
  <div class="lastpop" id="lastPop" aria-live="polite">
    <span class="lp-code" id="lpCode"></span>
    <span class="lp-total" id="lpTotal"></span>
  </div>

  <!-- Footer fisso: Sx Svuota ‚Äî Centro Copia ‚Äî Dx Invia -->
  <div class="footerbar" id="footerBar">
    <button id="clear" class="btn left">Svuota</button>
    <button id="copy"  class="btn center">Copia</button>
    <button id="send"  class="btn btn-primary right">Invia</button>
  </div>

  <!-- ZXing UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.2/umd/index.min.js"></script>
  <script>
  /******** CONFIG ********/
  const qp = (k, def="") => new URLSearchParams(location.search).get(k) ?? def;
  const FORWARD_URL = "https://scanner-bridge2.pages.dev/scanner/push"; // bridge CF
  const STORAGE_KEY = "scanner16.cameraId";
  const CODICE_LEN  = 16;

  const sid = qp("sid",""); // deve arrivare dal bot
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;

  /******** UI ********/
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>[...r.querySelectorAll(s)];
  const toast = $("#toast");
  const showToast=(msg,ms=1400)=>{ toast.textContent=msg; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"),ms); };

  /******** AUDIO BEEP ********/
  let audioReady=false, audioCtx=null;
  function ensureAudio(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==="suspended") audioCtx.resume(); audioReady=true; }
  function beep(freq=920, duration=90, vol=0.08){
    if (!audioReady) return;
    const ctx=audioCtx, o=ctx.createOscillator(), g=ctx.createGain();
    o.type="sine"; o.frequency.value=freq; g.gain.value=vol; o.connect(g); g.connect(ctx.destination);
    o.start(); setTimeout(()=>{ try{o.stop();}catch(_){}} , duration);
  }
  window.addEventListener('pointerdown', ensureAudio, { once:true });

  /******** MODEL ********/
  let scanning=false, devices=[], currentIndex=0, currentTrack=null, torchOn=false;
  const bag=[], dedup=new Set();
  let lastShown="", lastUiTick=0;

  const video=$("#preview");
  const btnFlip=$("#flip"), btnTorch=$("#torch");
  const btnCopy=$("#copy"), btnClear=$("#clear"), btnSend=$("#send");
  const drawer=$("#drawer"), openDrawerTop=$("#openDrawerTop"), closeDrawerBtn=$("#closeDrawer"), codeList=$("#codeList");

  // elementi popup
  const lastPop = $("#lastPop");
  const lpCode  = $("#lpCode");
  const lpTotal = $("#lpTotal");
  let lastPopTimer=null;

  /******** ZXing ********/
  const reader = new ZXing.BrowserMultiFormatReader(
    new Map([[ZXing.DecodeHintType.POSSIBLE_FORMATS,[
      ZXing.BarcodeFormat.QR_CODE, ZXing.BarcodeFormat.DATA_MATRIX, ZXing.BarcodeFormat.CODE_128, ZXing.BarcodeFormat.CODE_39,
      ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.EAN_8, ZXing.BarcodeFormat.ITF, ZXing.BarcodeFormat.UPC_A
    ]]]),
    250
  );

  /******** CORE ********/
  /* Nota: lasciamo la helper fmt4 definita ma NON la usiamo (richiesta: niente split 4-4-4-4) */
  const fmt4 = s => s.replace(/(.{4})/g, "$1 ").trim();

  function sanitizeAndSplit(raw){
    if(!raw) return [];
    let s=String(raw).toUpperCase().replace(/[^A-Z0-9]/g,'');
    if (s.length===CODICE_LEN) return [s];
    if (s.length>CODICE_LEN && s.length%CODICE_LEN===0){
      const out=[]; for(let i=0;i<s.length;i+=CODICE_LEN) out.push(s.slice(i,i+CODICE_LEN)); return out;
    }
    return [];
  }
  function renderList(){
    codeList.innerHTML="";
    if (!bag.length){
      const li=document.createElement("li"); li.textContent="Nessuna matricola letta."; li.style.color="var(--muted)"; li.style.padding="6px 2px";
      codeList.appendChild(li); return;
    }
    bag.forEach((c,idx)=>{
      const li=document.createElement("li"); li.className="row";
      li.innerHTML=`<span class="code">${String(idx+1).padStart(2,'0')}. ${c}</span>
                    <button class="x" data-code="${c}" title="Rimuovi">‚úï</button>`;
      codeList.appendChild(li);
    });
    $$(".x", codeList).forEach(btn=>{
      btn.onclick=()=>{
        const code=btn.getAttribute("data-code");
        if (dedup.has(code)){
          dedup.delete(code);
          const i=bag.indexOf(code); if (i>=0) bag.splice(i,1);
          renderList();
          lpTotal.textContent = `Totale: ${bag.length}`;
        }
      };
    });
  }

  function showLastPopup(codeText){
    /* NESSUNO split: mostra il codice intero */
    lpCode.textContent  = codeText;
    lpTotal.textContent = `Totale: ${bag.length}`;
    lastPop.classList.add("show");
    clearTimeout(lastPopTimer);
    /* visibile per 15 secondi */
    lastPopTimer = setTimeout(()=> lastPop.classList.remove("show"), 15000);
  }

  function addCodes(arr){
    let added=0;
    for(const c of arr){
      if (c.length!==CODICE_LEN) continue;
      if(!dedup.has(c)){ dedup.add(c); bag.push(c); added++; }
    }
    if (added>0){
      if (drawer.classList.contains("open")) renderList();
      const last = arr[arr.length-1];
      showLastPopup(last);
      beep(950,90,0.09);
    }
    return added;
  }

  function savePreferredCameraId(id){ try{ localStorage.setItem(STORAGE_KEY, id||""); }catch(_){} }
  function getPreferredCameraId(){ try{ return localStorage.getItem(STORAGE_KEY) || ""; }catch(_){ return ""; } }

  async function listCamerasAfterPermission(){
    try{
      const all=await navigator.mediaDevices.enumerateDevices();
      devices=all.filter(d=>d.kind==="videoinput");
      const preferredId=getPreferredCameraId();
      let idx=devices.findIndex(d=>d.deviceId===preferredId);
      if (idx<0){
        const backIdx=devices.findIndex(d=>/back|rear|post/i.test(d.label||'')); idx=backIdx>=0?backIdx:0;
      }
      currentIndex=Math.max(0,idx);
    }catch(e){}
  }
  async function requestEnvironmentOnce(){
    try{
      const tmp=await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ideal:"environment"}, width:{ideal:1920}, height:{ideal:1080} }, audio:false
      });
      tmp.getTracks().forEach(t=>t.stop());
    }catch(_){}
  }

  async function start(devId){
    if (scanning) return;
    scanning=true;
    try{
      await reader.decodeFromVideoDevice(devId||null, video, (result)=>{
        if (result){
          const text=result.getText();
          if (text && text!==lastShown){
            lastShown=text;
            const chunks=sanitizeAndSplit(text);
            addCodes(chunks);
          }
        }
      });
      const stream=video.srcObject;
      currentTrack=stream ? stream.getVideoTracks()[0] : null;
      if (!devices.length) await listCamerasAfterPermission();
      const usingId=devices[currentIndex]?.deviceId || "";
      if (usingId) savePreferredCameraId(usingId);
      showToast("Scanning‚Ä¶");
    }catch(e){
      scanning=false; showToast("Permesso negato o camera non disponibile",1800);
      try{ reader.reset(); }catch(_){}
    }
  }
  function stop(){
    if (!scanning) return;
    scanning=false;
    try{ reader.reset(); }catch(_){}
    try{ if(currentTrack) currentTrack.stop(); }catch(_){}
    currentTrack=null; torchOn=false;
    showToast("In attesa‚Ä¶");
  }
  async function flipCamera(){
    if (!devices.length){
      await listCamerasAfterPermission();
      if (!devices.length) return;
    }
    currentIndex=(currentIndex+1)%devices.length;
    const devId=devices[currentIndex]?.deviceId || null;
    savePreferredCameraId(devId||"");
    if (scanning){ stop(); await start(devId); } else { await start(devId); }
  }
  async function toggleTorch(){
    if (!currentTrack){ showToast("Torcia non disponibile"); return; }
    try{
      await currentTrack.applyConstraints({ advanced:[{ torch:!torchOn }] });
      torchOn=!torchOn; showToast(torchOn?"Torcia ON":"Torcia OFF",800);
    }catch(e){
      showToast("Torcia non supportata",1200);
    }
  }

  /******** ACTIONS ********/
  btnFlip.onclick  = flipCamera;
  btnTorch.onclick = toggleTorch;

  btnCopy.onclick = async ()=>{
    try{ await navigator.clipboard.writeText(bag.join(' ')); showToast(`Copiati ${bag.length} codici`); }
    catch(e){ showToast("Clipboard non disponibile"); }
  };
  btnClear.onclick = ()=>{ bag.length=0; dedup.clear(); renderList(); lastPop.classList.remove('show'); showToast("Svuotato"); };

  // Drawer (apri/chiudi dal top)
  const toggleDrawer=(open)=> drawer.classList.toggle("open", open);
  openDrawerTop.onclick = ()=>{ renderList(); toggleDrawer(true); };
  closeDrawerBtn.onclick= ()=> toggleDrawer(false);

  // INVIO (POST JSON al bridge)
  btnSend.onclick = async ()=>{
    if (!bag.length){ showToast("Nessun codice da inviare"); return; }
    if (tg){ tg.sendData(JSON.stringify({ codes: bag })); tg.close(); return; }
    if (!sid){ showToast("Manca SID (Apri dal bot)"); return; }

    try{
      const res = await fetch(FORWARD_URL, {
        method:"POST", mode:"cors", cache:"no-store", credentials:"omit",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ sid, codes:bag })
      });
      const text=await res.text().catch(()=>"(no body)");
      if (res.ok){ showToast(`Inviati ${bag.length}`); }
      else { console.warn("POST failed:", res.status, text); showToast(`Errore invio ${res.status}`); }
    }catch(e){
      console.error("Network error:", e); showToast("Errore rete");
    }
  };

  // Gestione visibilit√† (risparmio batteria)
  document.addEventListener("visibilitychange", ()=>{
    if (document.hidden) stop();
    else start(devices[currentIndex]?.deviceId || getPreferredCameraId() || null);
  });

  // Boot: autostart senza pulsanti
  (async function boot(){
    if (!sid){ showToast("‚ùå Link senza SID: apri dallo stesso bot"); return; }
    try{ await requestEnvironmentOnce(); } finally {
      await listCamerasAfterPermission();
      const preferredId=getPreferredCameraId();
      const devId = devices[currentIndex]?.deviceId || preferredId || null;
      await start(devId);
    }
  })();

  // Stop camera quando si lascia la pagina
  window.addEventListener("beforeunload", stop);




  const purpose = qp("purpose","");    // <-- AGGIUNGI QUESTO

  if (tg) { tg.ready(); tg.expand(); } // <-- ready()

  // ... resto invariato ...

  btnSend.onclick = async () => {
    if (!bag.length){ showToast("Nessun codice da inviare"); return; }

    // ‚úÖ INVIO VERSO IL BOT (update: message.web_app_data)
    if (tg){
      tg.sendData(JSON.stringify({ purpose, sid, codes: bag }));  // <-- manda anche purpose & sid
      tg.close();                                                 // opzionale
      return;
    }

    // ‚ôªÔ∏è Fallback verso il bridge HTTP (se apri fuori da Telegram)
    if (!sid){ showToast("Manca SID (Apri dal bot)"); return; }
    try{
      const res = await fetch(FORWARD_URL, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ purpose, sid, codes: bag })         // <-- anche qui
      });
      if (res.ok) showToast(`Inviati ${bag.length}`); else showToast(`Errore invio`);
    }catch(e){ showToast("Errore rete"); }
  };
  // DEBUG banner in alto
  document.body.insertAdjacentHTML(
    "afterbegin",
    `<div id="tgBanner" style="position:fixed;top:6px;left:6px;z-index:99999;
     background:${tg?'#16a34a':'#dc2626'};color:white;padding:6px 10px;border-radius:10px;font-weight:800">
     TG ${tg?'‚úÖ':'‚ùå'} | SID=${new URLSearchParams(location.search).get('sid')||'‚Äî'}
     | PURPOSE=${new URLSearchParams(location.search).get('purpose')||'‚Äî'}
     </div>`
  );
  tg ? tg.showAlert('Sono dentro Telegram ‚úÖ') : alert('Fuori da Telegram ‚ùå');
</script>

</body>
</html>
