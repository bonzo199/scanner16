<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scanner 16 â€“ Basic</title>
<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8;
    --border:#243b55; --accent:#22c55e;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:680px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:12px}
  h1{font-size:1.1rem;margin:0}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
  label{font-size:.9rem;color:var(--muted)}
  select,button,input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0a1529;color:var(--ink)}
  .row{display:grid;gap:8px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media (max-width:640px){ .grid2{grid-template-columns:1fr} }
  .btn{cursor:pointer}
  .btn-primary{background:var(--accent);border-color:transparent;color:#03110a;font-weight:700}
  video{width:100%;aspect-ratio:16/9;background:#000;border-radius:10px}
  .mono{font-family:ui-monospace,Consolas,monospace}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted);font-size:.8rem}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ðŸ“· Scanner 16 <span class="pill">solo blocchi da 16</span></h1>
    <div class="grid2" style="margin-top:8px">
      <div class="row">
        <label for="cameraSel">Fotocamera</label>
        <select id="cameraSel"></select>
      </div>
      <div class="row">
        <label>&nbsp;</label>
        <div class="grid2">
          <button id="btnStart" class="btn btn-primary">Avvia</button>
          <button id="btnStop" class="btn">Stop</button>
        </div>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <video id="preview" playsinline muted></video>
    </div>
  </div>

  <div class="card">
    <div class="grid2">
      <div>
        <label>Ultimo</label>
        <div id="last" class="mono">â€”</div>
      </div>
      <div>
        <label>Stato</label>
        <div id="status" class="mono">In attesaâ€¦</div>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <label>Raccolta (spazio-separati)</label>
      <textarea id="bag" rows="3" class="mono" placeholder="VUOTO"></textarea>
    </div>
    <div class="grid2" style="margin-top:8px">
      <button id="btnCopy" class="btn">Copia</button>
      <button id="btnCSV" class="btn">CSV</button>
    </div>
    <div class="grid2" style="margin-top:8px">
      <button id="btnClear" class="btn">Svuota</button>
      <button id="btnSend" class="btn btn-primary">Invia</button>
    </div>
  </div>

  <div class="card" id="advanced">
    <label>Endpoint (opzionale fuori Telegram)</label>
    <input id="endpoint" placeholder="https://tuo-backend/scanner/push">
    <label style="margin-top:6px">Bearer token (opzionale)</label>
    <input id="token" placeholder="Bearer <TOKEN>">
  </div>
</div>

<!-- ZXing UMD: espone 'ZXing' -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.2/umd/index.min.js"></script>
<script>
  // ====== Config & stato ======
  const CODICE_LEN = 16;
  let devices = [];
  let currentTrack = null;
  const bag = [];      // codici raccolti
  const dedup = new Set();

  const video = document.getElementById('preview');
  const cameraSel = document.getElementById('cameraSel');
  const statusEl = document.getElementById('status');
  const lastEl = document.getElementById('last');
  const endpointEl = document.getElementById('endpoint');
  const tokenEl = document.getElementById('token');
  const tg = window.Telegram ? window.Telegram.WebApp : null;

  // ====== Util 16 ======
  function normalize(raw){
    if(!raw) return [];
    let s = String(raw).toUpperCase().replace(/[^A-Z0-9]/g,'');
    if (s.length === CODICE_LEN) return [s];
    if (s.length > CODICE_LEN && s.length % CODICE_LEN === 0) {
      const out = [];
      for (let i=0;i<s.length;i+=CODICE_LEN) out.push(s.slice(i,i+CODICE_LEN));
      return out;
    }
    return []; // scarta tutto ciÃ² che non Ã¨ multiplo di 16
  }
  function renderBag(){ document.getElementById('bag').value = bag.join(' '); }
  function addCodes(codes){
    let added=0;
    for(const c of codes){
      if (c.length!==CODICE_LEN) continue;
      if(!dedup.has(c)){ dedup.add(c); bag.push(c); added++; }
    }
    if(added>0) renderBag();
    return added;
  }

  // ====== ZXing setup (UMD: 'ZXing') ======
  const codeReader = new ZXing.BrowserMultiFormatReader();
  async function listCameras(){
    devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
    cameraSel.innerHTML = '';
    devices.forEach((d,i)=>{
      const opt = document.createElement('option');
      opt.value = d.deviceId;
      opt.textContent = d.label || `Camera ${i+1}`;
      cameraSel.appendChild(opt);
    });
    // prefer back camera se possibile
    const backIndex = devices.findIndex(d => /back|rear|post/i.test(d.label||''));
    cameraSel.selectedIndex = backIndex>=0 ? backIndex : 0;
  }

  async function start(){
    stop();
    const devId = devices[cameraSel.selectedIndex]?.deviceId;
    statusEl.textContent = 'Scanning...';
    await codeReader.decodeFromVideoDevice(devId, video, (result, err) => {
      if (result) {
        const chunks = normalize(result.getText());
        const added = addCodes(chunks);
        if (added>0){ lastEl.textContent = chunks.join(' '); }
      }
    });
    const stream = video.srcObject;
    currentTrack = stream ? stream.getVideoTracks()[0] : null;
  }
  function stop(){
    try{ codeReader.reset(); }catch(e){}
    try{ if(currentTrack) currentTrack.stop(); }catch(e){}
    currentTrack = null;
    statusEl.textContent = 'In attesaâ€¦';
  }

  // ====== UI ======
  document.getElementById('btnStart').onclick = start;
  document.getElementById('btnStop').onclick  = stop;
  cameraSel.onchange = start;

  document.getElementById('btnCopy').onclick = async ()=>{
    await navigator.clipboard.writeText(bag.join(' '));
    statusEl.textContent = `Copiati ${bag.length} codici`;
  };
  document.getElementById('btnCSV').onclick = ()=>{
    const csv = 'codice\\n' + bag.join('\\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = 'scanner16.csv'; a.click();
  };
  document.getElementById('btnClear').onclick = ()=>{
    bag.length = 0; dedup.clear(); renderBag(); lastEl.textContent='â€”'; statusEl.textContent='In attesaâ€¦';
  };

  const btnSend = document.getElementById('btnSend');
  if (tg) {
    document.getElementById('advanced').style.display = 'none';
    tg.expand();
    btnSend.textContent = "Invia al bot";
    btnSend.onclick = ()=>{ tg.sendData(JSON.stringify({ codes: bag })); tg.close(); };
  } else {
    btnSend.onclick = async ()=>{
      const url = endpointEl.value.trim();
      if(!url){ statusEl.textContent='Specifica endpoint'; return; }
      const token = tokenEl.value.trim();
      const res = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json', ...(token?{'Authorization':token}:{})},
        body: JSON.stringify({ codes: bag, ts: Date.now() })
      });
      statusEl.textContent = res.ok ? `Inviati ${bag.length} codici` : `Errore invio: ${res.status}`;
    };
  }

  (async ()=>{ await listCameras(); })();
</script>
</body>
</html>
