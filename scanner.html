<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scanner 16 â€“ OpsHub</title>
<style>
  :root{
    --bg:#ffffff; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
    --blue:#1e3a8a; --blue-2:#3b82f6; --chip:#eef2ff;
    --glass:rgba(255,255,255,.58); --shadow:0 12px 32px rgba(2,6,23,.18);
    --footer-h:66px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
  .container{max-width:1060px;margin:0 auto;padding:8px 8px 0}

  /* Camera */
  .video-wrap{position:relative;border:1px solid var(--border);border-radius:18px;overflow:hidden;
    box-shadow:0 10px 30px rgba(2,6,23,.06);background:#000;}
  video#preview{width:100%;height:82vh;min-height:440px;max-height:88vh;object-fit:cover;display:block;background:#000}

  /* Overlay TOP (senza select) */
  .ov{position:absolute;left:50%;transform:translateX(-50%);z-index:10040;display:flex;align-items:center;gap:10px;flex-wrap:wrap;
    background:var(--glass);backdrop-filter:blur(10px) saturate(1.05);border:1px solid rgba(229,231,235,.7);
    border-radius:16px;padding:8px 10px;box-shadow:var(--shadow);width:calc(100% - 16px);max-width:980px}
  .ov.top{top:10px}
  .ov .sp{flex:1}
  .btn{height:46px;padding:0 14px;border-radius:14px;border:1px solid var(--border);background:#fff;color:var(--ink);font-weight:700;cursor:pointer}
  .btn:hover{background:#f8fafc}.btn:active{transform:translateY(1px)}
  .btn-icon{width:56px;height:56px;padding:0;border-radius:999px;display:flex;align-items:center;justify-content:center;font-size:30px;line-height:1}
  .btn-primary{background:linear-gradient(135deg,var(--blue-2),var(--blue));color:#fff;border-color:transparent;box-shadow:0 8px 18px rgba(30,58,138,.28)}
  .btn-primary:hover{filter:brightness(0.96)}
  .badge{padding:6px 12px;border-radius:999px;border:1px solid var(--border);background:#f8fafc;font-size:.9rem}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--chip);font-family:ui-monospace,Consolas,monospace;font-size:.9rem}

  /* Drawer Matricole (dentro la camera e SOPRA alla toolbar top) */
  .drawer{position:absolute;right:12px;bottom:12px;z-index:10050;width:min(380px,calc(100% - 24px));max-height:70vh;display:flex;flex-direction:column;gap:8px;
    background:var(--glass);backdrop-filter:blur(10px) saturate(1.05);border:1px solid rgba(229,231,235,.7);border-radius:16px;box-shadow:var(--shadow);
    overflow:hidden;opacity:0;transform:translateY(8px);pointer-events:none;transition:opacity .16s ease,transform .16s ease}
  .drawer.open{opacity:1;transform:translateY(0);pointer-events:auto}
  .drawer .head{display:flex;align-items:center;gap:10px;padding:8px 10px;background:linear-gradient(135deg,#f8fafc,#fff);border-bottom:1px solid var(--border)}
  .drawer .title{font-weight:700}.drawer .body{padding:8px 10px;overflow:auto}
  .drawer .list{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:6px}
  .drawer .row{display:flex;align-items:center;gap:8px;justify-content:space-between;border:1px solid var(--border);border-radius:12px;background:#fff;padding:6px 8px}
  .drawer .code{font-family:ui-monospace,Consolas,monospace;font-size:.95rem;letter-spacing:.5px}
  .drawer .x{border:none;background:#fee2e2;color:#991b1b;border-radius:10px;padding:6px 8px;cursor:pointer;font-weight:700}
  .drawer .x:hover{filter:brightness(.96)}

  /* Toast (in alto a destra nel video) */
  .toast{position:absolute;right:12px;top:12px;z-index:10060;background:#0ea5e9;color:white;border-radius:12px;padding:8px 12px;box-shadow:var(--shadow);font-weight:700;display:none}
  .toast.show{display:block}

  /* Toolbar bassa: sotto la camera, in flow + sticky */
  .footer-wrap{max-width:1060px;margin:10px auto 12px;padding:0 8px}
  .footerbar{position:sticky;top:calc(100svh - var(--footer-h) - 10px);z-index:5000;display:flex;align-items:center;gap:10px;flex-wrap:wrap;
    width:100%;padding:10px 12px;height:var(--footer-h);background:linear-gradient(180deg,rgba(255,255,255,.88),rgba(255,255,255,.98));
    border:1px solid rgba(229,231,235,.9);border-radius:16px;box-shadow:0 8px 20px rgba(2,6,23,.08);backdrop-filter:blur(8px)}
  .footerbar .sp{flex:1}
  .footerbar .btn{height:46px;padding:0 14px;border-radius:14px;border:1px solid var(--border);background:#fff;font-weight:700}
  .footerbar .btn:hover{background:#f8fafc}
  .footerbar .btn-primary{background:linear-gradient(135deg,var(--blue-2),var(--blue));color:#fff;border-color:transparent;box-shadow:0 8px 18px rgba(30,58,138,.28)}
  .footerbar .chip{background:var(--chip);border:1px solid var(--border)}

  @media (max-width:760px){
    video#preview{height:78vh;min-height:360px}
    .btn-icon{width:52px;height:52px;font-size:28px}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="video-wrap">
      <video id="preview" playsinline muted></video>

      <!-- Overlay TOP (solo controlli) -->
      <div class="ov top" id="ovTop">
        <button id="flip"  class="btn btn-icon" title="Cambia camera">â†º</button>
        <button id="torch" class="btn btn-icon" title="Torcia">ðŸ”¦</button>
        <div class="sp"></div>
        <button id="start" class="btn btn-primary">â–¶ Avvia</button>
        <button id="stop"  class="btn">â–  Stop</button>
      </div>

      <!-- Drawer Matricole -->
      <div class="drawer" id="drawer">
        <div class="head">
          <div class="title">Matricole lette</div>
          <div class="sp"></div>
          <button id="closeDrawer" class="btn btn-icon" title="Chiudi">âœ•</button>
        </div>
        <div class="body"><ul class="list" id="codeList"></ul></div>
      </div>

      <!-- Toast -->
      <div class="toast" id="toast">Pronto</div>
    </div>
  </div>

  <!-- Toolbar bassa (sotto la camera) -->
  <div class="footer-wrap">
    <div class="footerbar" id="footerBar">
      <div class="chip">Ultimo: <span id="last">â€”</span></div>
      <div class="badge">Totale: <span id="count">0</span></div>
      <div class="sp"></div>
      <button id="openDrawer" class="btn">Matricole</button>
      <button id="copy"  class="btn">Copia</button>
      <button id="clear" class="btn">Svuota</button>
      <button id="send"  class="btn btn-primary">Invia</button>
    </div>
  </div>

  <!-- ZXing UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.2/umd/index.min.js"></script>
  <script>
  /******** CONFIG ********/
  // Passa ?bridge=<URL del worker> e opzionale ?btok=<token> per header X-Bridge-Token
  const qp = (k, def="") => new URLSearchParams(location.search).get(k) ?? def;
  const FORWARD_URL = "https://scanner-bridge2.pages.dev/scanner/push"; // o scanner-bridge.pages.dev

  const FORWARD_TOKEN = qp("btok", "");
  const STORAGE_KEY   = "scanner16.cameraId";
  const CODICE_LEN    = 16;

  const sid = qp("sid","");
  const tg  = window.Telegram ? window.Telegram.WebApp : null; if (tg) tg.expand();

  /******** UI HELPERS ********/
  const $ = (s,r=document)=>r.querySelector(s);
  const $$= (s,r=document)=>[...r.querySelectorAll(s)];
  const toast = $("#toast");
  const showToast=(msg,ms=1400)=>{ toast.textContent=msg; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"),ms); };

  /******** AUDIO BEEP ********/
  let audioReady=false, audioCtx=null;
  function ensureAudio(){
    if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume();
    audioReady = true;
  }
  function beep(freq=880, duration=90, vol=0.08){
    if (!audioReady) return;
    const ctx=audioCtx; const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type="sine"; o.frequency.value=freq; g.gain.value=vol;
    o.connect(g); g.connect(ctx.destination); o.start();
    setTimeout(()=>{ try{o.stop();}catch(_){}} , duration);
  }

  /******** MODEL ********/
  let scanning=false, devices=[], currentIndex=0, currentTrack=null, torchOn=false;
  const bag=[], dedup=new Set();
  let lastShown="", lastUiTick=0;

  // UI refs
  const video   = $("#preview");
  const btnStart= $("#start"), btnStop  = $("#stop"), btnFlip = $("#flip"), btnTorch = $("#torch");
  const btnCopy = $("#copy"), btnClear = $("#clear"), btnSend = $("#send");
  const countEl = $("#count"), lastEl  = $("#last");
  const drawer  = $("#drawer"), openDrawerBtn = $("#openDrawer"), closeDrawerBtn = $("#closeDrawer"), codeList=$("#codeList");

  /******** ZXing ********/
  const reader = new ZXing.BrowserMultiFormatReader(
    new Map([[ZXing.DecodeHintType.POSSIBLE_FORMATS,[
      ZXing.BarcodeFormat.QR_CODE, ZXing.BarcodeFormat.DATA_MATRIX, ZXing.BarcodeFormat.CODE_128, ZXing.BarcodeFormat.CODE_39,
      ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.EAN_8, ZXing.BarcodeFormat.ITF, ZXing.BarcodeFormat.UPC_A
    ]]]),
    250
  );

  /******** CORE ********/
  function sanitizeAndSplit(raw){
    if(!raw) return [];
    let s=String(raw).toUpperCase().replace(/[^A-Z0-9]/g,'');
    if (s.length===CODICE_LEN) return [s];
    if (s.length>CODICE_LEN && s.length%CODICE_LEN===0){
      const out=[]; for(let i=0;i<s.length;i+=CODICE_LEN) out.push(s.slice(i,i+CODICE_LEN)); return out;
    }
    return [];
  }
  function renderCounters(){ countEl.textContent=String(bag.length); }
  function renderLast(text){
    const now=performance.now(); if (now-lastUiTick<120) return; lastUiTick=now;
    requestAnimationFrame(()=>{ lastEl.textContent=text; });
  }
  function renderList(){
    codeList.innerHTML="";
    if (!bag.length){
      const li=document.createElement("li"); li.textContent="Nessuna matricola letta."; li.style.color="var(--muted)"; li.style.padding="6px 2px";
      codeList.appendChild(li); return;
    }
    bag.forEach((c,idx)=>{
      const li=document.createElement("li"); li.className="row";
      li.innerHTML=`<span class="code">${String(idx+1).padStart(2,'0')}. ${c}</span>
                    <button class="x" data-code="${c}" title="Rimuovi">âœ•</button>`;
      codeList.appendChild(li);
    });
    $$(".x", codeList).forEach(btn=>{
      btn.onclick=()=>{
        const code=btn.getAttribute("data-code");
        if (dedup.has(code)){
          dedup.delete(code);
          const i=bag.indexOf(code); if (i>=0) bag.splice(i,1);
          renderCounters(); renderList();
        }
      };
    });
  }
  function addCodes(arr){
    let added=0;
    for(const c of arr){
      if (c.length!==CODICE_LEN) continue;
      if(!dedup.has(c)){ dedup.add(c); bag.push(c); added++; }
    }
    if (added>0){
      renderCounters(); renderLast(arr.join(" "));
      if (drawer.classList.contains("open")) renderList();
      beep(950,90,0.09); // BEEP alla lettura
    }
    return added;
  }

  function savePreferredCameraId(id){ try{ localStorage.setItem(STORAGE_KEY, id||""); }catch(_){} }
  function getPreferredCameraId(){ try{ return localStorage.getItem(STORAGE_KEY) || ""; }catch(_){ return ""; } }

  async function listCamerasAfterPermission(){
    try{
      const all=await navigator.mediaDevices.enumerateDevices();
      devices=all.filter(d=>d.kind==="videoinput");
      // selezione preferita/back
      const preferredId=getPreferredCameraId();
      let idx=devices.findIndex(d=>d.deviceId===preferredId);
      if (idx<0){
        const backIdx=devices.findIndex(d=>/back|rear|post/i.test(d.label||'')); idx=backIdx>=0?backIdx:0;
      }
      currentIndex=Math.max(0,idx);
    }catch(e){}
  }
  async function requestEnvironmentOnce(){
    try{
      const tmp=await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ideal:"environment"}, width:{ideal:1920}, height:{ideal:1080} }, audio:false
      });
      tmp.getTracks().forEach(t=>t.stop());
    }catch(_){}
  }

  async function start(devId){
    if (scanning) return;
    scanning=true; btnStart.disabled=true; ensureAudio(); showToast("Apertura cameraâ€¦",900);
    try{
      await reader.decodeFromVideoDevice(devId||null, video, (result)=>{
        if (result){
          const text=result.getText();
          if (text && text!==lastShown){
            lastShown=text;
            const chunks=sanitizeAndSplit(text);
            addCodes(chunks);
          }
        }
      });
      const stream=video.srcObject;
      currentTrack=stream ? stream.getVideoTracks()[0] : null;
      if (!devices.length) await listCamerasAfterPermission();
      const usingId=devices[currentIndex]?.deviceId || "";
      if (usingId) savePreferredCameraId(usingId);
      showToast("Scanningâ€¦");
    }catch(e){
      scanning=false; btnStart.disabled=false; showToast("Permesso negato o camera non disponibile",1800);
      try{ reader.reset(); }catch(_){}
    }
  }
  function stop(){
    if (!scanning) return;
    scanning=false; btnStart.disabled=false;
    try{ reader.reset(); }catch(_){}
    try{ if(currentTrack) currentTrack.stop(); }catch(_){}
    currentTrack=null; torchOn=false;
    showToast("In attesaâ€¦");
  }
  async function flipCamera(){
    if (!devices.length){
      await listCamerasAfterPermission();
      if (!devices.length) return;
    }
    currentIndex=(currentIndex+1)%devices.length;
    const devId=devices[currentIndex]?.deviceId || null;
    savePreferredCameraId(devId||"");
    if (scanning){ stop(); await start(devId); } else { showToast("Camera cambiata"); }
  }
  async function toggleTorch(){
    if (!currentTrack){ showToast("Torcia non disponibile"); return; }
    try{
      await currentTrack.applyConstraints({ advanced:[{ torch:!torchOn }] });
      torchOn=!torchOn; showToast(torchOn?"Torcia ON":"Torcia OFF",800);
    }catch(e){
      showToast("Torcia non supportata",1200);
    }
  }

  /******** ACTIONS ********/
  btnStart.onclick = ()=>{ const devId=devices[currentIndex]?.deviceId || getPreferredCameraId() || null; start(devId); };
  btnStop.onclick  = stop;
  btnFlip.onclick  = flipCamera;
  btnTorch.onclick = toggleTorch;

  btnCopy.onclick = async ()=>{
    try{ await navigator.clipboard.writeText(bag.join(' ')); showToast(`Copiati ${bag.length} codici`); }
    catch(e){ showToast("Clipboard non disponibile"); }
  };
  btnClear.onclick = ()=>{ bag.length=0; dedup.clear(); renderCounters(); renderList(); lastShown=""; lastEl.textContent='â€”'; showToast("Svuotato"); };

  // Drawer sempre sopra: z-index 10050 > top bar 10040
  const toggleDrawer=(open)=> drawer.classList.toggle("open", open);
  $("#openDrawer").onclick = ()=>{ renderList(); toggleDrawer(true); };
  $("#closeDrawer").onclick= ()=> toggleDrawer(false);

  // INVIO (Cloudflare bridge + fallback)
  btnSend.onclick = async ()=>{
    if (!bag.length){ showToast("Nessun codice da inviare"); return; }
    if (tg){ tg.sendData(JSON.stringify({ codes: bag })); tg.close(); return; }
    if (!sid){ showToast("Manca SID (Apri nel browser dal bot)"); return; }

    const payload = { sid, codes:bag, origin:location.origin };
    const headers = { "Content-Type":"application/json" };
    if (FORWARD_TOKEN) headers["X-Bridge-Token"] = FORWARD_TOKEN;

    try{
      const res = await fetch(FORWARD_URL, {
        method:"POST", mode:"cors", cache:"no-store", credentials:"omit",
        headers, body: JSON.stringify(payload)
      });
      const text=await res.text().catch(()=>"(no body)");
      if (res.ok){ showToast(`Inviati ${bag.length}`); }
      else{
        console.warn("POST failed:", res.status, text);
        // Fallback GET (URL corto; se lungo potrebbe fallire)
        const q = new URLSearchParams({ sid, origin: location.origin, codes: bag.join(" ") }).toString();
        const g = await fetch(FORWARD_URL + (FORWARD_URL.includes("?")?"&":"?") + q, { method:"GET", mode:"cors", cache:"no-store" });
        if (g.ok){ showToast(`Inviati (GET)`); } else { showToast(`Errore invio ${res.status}`); }
      }
    }catch(e){
      console.error("Network error:", e);
      showToast("Errore rete");
    }
  };

  // Boot
  (async function boot(){
    try{ await requestEnvironmentOnce(); }
    finally{
      await listCamerasAfterPermission();
      const preferredId=getPreferredCameraId();
      const idx = preferredId ? devices.findIndex(d=>d.deviceId===preferredId) : -1;
      if (idx>=0) currentIndex=idx;
      const autostart = qp("autostart","0")==="1" || !!preferredId;
      if (autostart){
        const devId=devices[currentIndex]?.deviceId || preferredId || null;
        if (devId) start(devId);
      } else {
        showToast("Pronto");
      }
    }
  })();
  </script>
</body>
</html>
