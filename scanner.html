<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scanner 16</title>
<style>
  :root{
    --bg:#ffffff; --ink:#0f172a; --muted:#64748b;
    --border:#e5e7eb; --accent:#2563eb; --accent-2:#1e40af;
    --shadow:0 10px 30px rgba(2,6,23,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
  .container{max-width:920px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:14px}
  .card{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:14px}
  .header{display:flex;align-items:center;gap:10px}
  .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#eef2ff,#ffffff);display:flex;align-items:center;justify-content:center;border:1px solid var(--border);font-size:18px}
  h1{font-size:1.2rem;margin:0}
  .sub{color:var(--muted);font-size:.9rem;margin-top:2px}

  /* Toolbar minimal */
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:10px}
  .toolbar-left{display:flex;gap:8px;align-items:center;flex:1}
  .toolbar-right{display:flex;gap:8px;align-items:center}
  label{font-size:.85rem;color:var(--muted)}
  select,button,textarea{padding:11px;border-radius:12px;border:1px solid var(--border);font-size:1rem;background:#fff;color:var(--ink)}
  select{min-width:220px;max-width:100%}
  .btn{cursor:pointer;font-weight:700}
  .btn:active{transform:translateY(1px)}
  .btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn-primary:hover{background:var(--accent-2)}
  .btn-ghost{background:#f8fafc}
  .btn-icon{width:46px;height:46px;display:flex;align-items:center;justify-content:center}

  /* Video grande, pochi fronzoli */
  .video-wrap{border:1px solid var(--border);border-radius:14px;overflow:hidden}
  video{width:100%;height:80vh;min-height:420px;max-height:85vh;background:#000;object-fit:cover;display:block}

  .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .badge{padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:.85rem;background:#f8fafc}
  .mono{font-family:ui-monospace,Consolas,monospace}

  textarea{min-height:110px;resize:vertical;width:100%}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media (max-width:760px){
    .grid2{grid-template-columns:1fr}
    .toolbar{flex-direction:column;align-items:stretch}
    .toolbar-right{width:100%;justify-content:flex-start}
    video{height:78vh;min-height:360px}
  }
</style>
</head>
<body>
<div class="container">

  <!-- CARD SCAN -->
  <div class="card">
    <div class="header">
      <div class="logo">📷</div>
      <div>
        <h1>Scanner 16</h1>
        <div class="sub">Solo <b>blocchi da 16</b> (alfanumerici, MAIUSCOLI). I multipli di 16 vengono spezzati automaticamente.</div>
      </div>
    </div>

    <div class="toolbar">
      <div class="toolbar-left">
        <div>
          <label for="cameraSel">Fotocamera (memorizzata)</label><br/>
          <select id="cameraSel" aria-label="Seleziona fotocamera"></select>
        </div>
      </div>
      <div class="toolbar-right">
        <button id="btnFlip"  class="btn btn-ghost btn-icon" title="Cambia camera">↺</button>
        <button id="btnTorch" class="btn btn-ghost btn-icon" title="Torcia">🔦</button>
        <button id="btnStart" class="btn btn-primary">Avvia</button>
        <button id="btnStop"  class="btn btn-ghost">Stop</button>
      </div>
    </div>

    <div class="video-wrap">
      <video id="preview" playsinline muted></video>
    </div>

    <div class="badges">
      <div class="badge">Stato: <span id="status" class="mono">In attesa…</span></div>
      <div class="badge">Ultimo: <span id="last" class="mono">—</span></div>
      <div class="badge">Totale: <span id="count" class="mono">0</span></div>
    </div>
  </div>

  <!-- CARD LISTA -->
  <div class="card">
    <label>Raccolta (spazio-separati)</label>
    <textarea id="bag" class="mono" placeholder="VUOTO"></textarea>
    <div class="grid2" style="margin-top:8px">
      <button id="btnCopy" class="btn btn-ghost">Copia</button>
      <button id="btnClear" class="btn btn-ghost">Svuota</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnSend" class="btn btn-primary">Invia al bot</button>
    </div>
  </div>

</div>

<!-- ZXing UMD (global: ZXing) -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.2/umd/index.min.js"></script>
<script>
  /***** CONFIG: ponte server (solo per uso FUORI da Telegram) *****/
  const FORWARD_URL   = "https://script.google.com/macros/s/AKfycbz3_eb26ihqnqG_RJ5yqb6Z_gQuaNN3_ETu3UCl1tkCbepRbQFarefhDH2jyypHbX0e/exec";
  const FORWARD_TOKEN = ""; // opzionale

  const STORAGE_KEY = "scanner16.cameraId";

  function qp(name, def=""){
    const v = new URLSearchParams(location.search).get(name);
    return v ?? def;
  }
  function getSidFromURL(){ return qp("sid",""); }

  /***** CORE *****/
  const CODICE_LEN = 16;
  const reader = new ZXing.BrowserMultiFormatReader(
    new Map([[ZXing.DecodeHintType.POSSIBLE_FORMATS, [
      ZXing.BarcodeFormat.QR_CODE,
      ZXing.BarcodeFormat.DATA_MATRIX,
      ZXing.BarcodeFormat.CODE_128,
      ZXing.BarcodeFormat.CODE_39,
      ZXing.BarcodeFormat.EAN_13,
      ZXing.BarcodeFormat.EAN_8,
      ZXing.BarcodeFormat.ITF,
      ZXing.BarcodeFormat.UPC_A
    ]]]),
    250
  );

  let scanning = false, devices = [], currentIndex = 0, currentTrack = null, torchOn = false;
  const bag = []; const dedup = new Set();
  let lastShown = "", lastUiTick = 0;

  const video     = document.getElementById('preview');
  const cameraSel = document.getElementById('cameraSel');
  const statusEl  = document.getElementById('status');
  const lastEl    = document.getElementById('last');
  const countEl   = document.getElementById('count');
  const bagEl     = document.getElementById('bag');

  const btnStart = document.getElementById('btnStart');
  const btnStop  = document.getElementById('btnStop');
  const btnFlip  = document.getElementById('btnFlip');
  const btnTorch = document.getElementById('btnTorch');
  const btnCopy  = document.getElementById('btnCopy');
  const btnClear = document.getElementById('btnClear');
  const btnSend  = document.getElementById('btnSend');
  const tg = window.Telegram ? window.Telegram.WebApp : null;
  if (tg) tg.expand();

  function sanitizeAndSplit(raw){
    if(!raw) return [];
    let s = String(raw).toUpperCase().replace(/[^A-Z0-9]/g,'');
    if (s.length === CODICE_LEN) return [s];
    if (s.length > CODICE_LEN && s.length % CODICE_LEN === 0) {
      const out = [];
      for (let i=0;i<s.length;i+=CODICE_LEN) out.push(s.slice(i,i+CODICE_LEN));
      return out;
    }
    return [];
  }
  function renderBag(){ bagEl.value = bag.join(' '); countEl.textContent = String(bag.length); }
  function addCodes(arr){
    let added = 0;
    for(const c of arr){
      if (c.length!==CODICE_LEN) continue;
      if(!dedup.has(c)){ dedup.add(c); bag.push(c); added++; }
    }
    if (added>0) renderBag();
    return added;
  }
  function uiUpdateLast(text){
    const now = performance.now();
    if (now - lastUiTick < 120) return; // throttle
    lastUiTick = now;
    requestAnimationFrame(()=>{ lastEl.textContent = text; });
  }

  function savePreferredCameraId(id){
    try{ localStorage.setItem(STORAGE_KEY, id || ""); }catch(_){}
  }
  function getPreferredCameraId(){
    try{ return localStorage.getItem(STORAGE_KEY) || ""; }catch(_){ return ""; }
  }

  async function listCamerasAfterPermission(){
    try{
      const all = await navigator.mediaDevices.enumerateDevices();
      devices = all.filter(d => d.kind === 'videoinput');
      cameraSel.innerHTML = '';
      const preferredId = getPreferredCameraId();

      devices.forEach((d,i)=>{
        const opt = document.createElement('option');
        opt.value = d.deviceId || '';
        const isBack = /back|rear|post/i.test(d.label||'');
        opt.textContent = d.label || (isBack ? `Fotocamera posteriore ${i+1}` : `Fotocamera ${i+1}`);
        cameraSel.appendChild(opt);
      });

      // scelta iniziale: preferita → back camera → prima
      let idx = devices.findIndex(d => d.deviceId === preferredId);
      if (idx < 0) {
        const backIdx = devices.findIndex(d => /back|rear|post/i.test(d.label||''));
        idx = backIdx >= 0 ? backIdx : 0;
      }
      currentIndex = Math.max(0, idx);
      cameraSel.selectedIndex = currentIndex;
    }catch(e){}
  }

  async function requestEnvironmentOnce(){
    // Chiede una volta i permessi con facingMode: environment per popolare i label
    try{
      const tmp = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1920 }, height: { ideal: 1080 }
        },
        audio: false
      });
      // rilascia subito
      tmp.getTracks().forEach(t => t.stop());
    }catch(_){}
  }

  async function start(devId){
    if (scanning) return;
    scanning = true; btnStart.disabled = true; statusEl.textContent = 'Apertura camera…';
    try{
      await reader.decodeFromVideoDevice(devId || null, video, (result) => {
        if (result) {
          const text = result.getText();
          if (text && text !== lastShown) {
            lastShown = text;
            const chunks = sanitizeAndSplit(text);
            const added = addCodes(chunks);
            if (added>0) uiUpdateLast(chunks.join(' '));
          }
        }
      });
      const stream = video.srcObject;
      currentTrack = stream ? stream.getVideoTracks()[0] : null;
      if (!devices.length) await listCamerasAfterPermission();
      // salva la camera in uso come preferita
      const usingId = devices[currentIndex]?.deviceId || "";
      if (usingId) savePreferredCameraId(usingId);

      statusEl.textContent = 'Scanning...';
    }catch(e){
      statusEl.textContent = 'Camera non disponibile o permesso negato';
      scanning = false; btnStart.disabled = false;
      try{ reader.reset(); }catch(_){}
    }
  }
  function stop(){
    if (!scanning) return;
    scanning = false; btnStart.disabled = false;
    try{ reader.reset(); }catch(_){}
    try{ if(currentTrack) currentTrack.stop(); }catch(_){}
    currentTrack = null; torchOn = false;
    statusEl.textContent = 'In attesa…';
  }

  async function flipCamera(){
    if (!devices.length) return;
    currentIndex = (currentIndex + 1) % devices.length;
    cameraSel.selectedIndex = currentIndex;
    const devId = devices[currentIndex]?.deviceId || null;
    savePreferredCameraId(devId || "");
    if (scanning) { stop(); await start(devId); }
  }
  async function toggleTorch(){
    if (!currentTrack) { statusEl.textContent = 'Torcia non disponibile'; return; }
    try{
      await currentTrack.applyConstraints({ advanced: [{ torch: !torchOn }] });
      torchOn = !torchOn;
      statusEl.textContent = torchOn ? 'Torcia ON' : 'Torcia OFF';
    }catch(e){
      statusEl.textContent = 'Torcia non supportata';
    }
  }

  // Handlers
  btnStart.onclick = ()=>{ const devId = devices[currentIndex]?.deviceId || getPreferredCameraId() || null; start(devId); };
  btnStop.onclick  = stop;
  btnFlip.onclick  = flipCamera;
  btnTorch.onclick = toggleTorch;
  cameraSel.onchange = async ()=>{
    if (!devices.length) return;
    currentIndex = cameraSel.selectedIndex||0;
    const devId = devices[currentIndex]?.deviceId || "";
    savePreferredCameraId(devId);
    if (scanning){ stop(); start(devId); }
  };

  btnCopy.onclick = async ()=>{ try{ await navigator.clipboard.writeText(bag.join(' ')); statusEl.textContent = `Copiati ${bag.length} codici`; }catch(e){ statusEl.textContent = 'Clipboard non disponibile'; } };
  btnClear.onclick = ()=>{ bag.length=0; dedup.clear(); renderBag(); lastShown=""; lastEl.textContent='—'; statusEl.textContent='In attesa…'; };

  btnSend.onclick = async ()=>{
    if (!bag.length) { statusEl.textContent = "Nessun codice da inviare"; return; }

    const tg = window.Telegram ? window.Telegram.WebApp : null;
    if (tg) { tg.sendData(JSON.stringify({ codes: bag })); tg.close(); return; }

    const sid = getSidFromURL();
    if (!sid) { statusEl.textContent = "Link senza SID: apri dal bot con “Apri nel browser”"; return; }

    try{
      const res = await fetch(FORWARD_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ sid, codes: bag, origin: location.origin, token: FORWARD_TOKEN })
      });
      const text = await res.text().catch(()=>"(no body)");
      if (res.ok) {
        statusEl.textContent = `Inviati ${bag.length} codici`;
      } else {
        statusEl.textContent = `Errore invio ${res.status}: ${text}`;
      }
    }catch(e){
      statusEl.textContent = `Errore rete: ${e?.message || e}`;
    }
  };

  // Boot: chiedi permessi una volta per avere i label, poi popola select, poi autostart se richiesto o se esiste preferita
  (async function boot(){
    const autostart = qp("autostart","0") === "1";
    try{
      await requestEnvironmentOnce();
    }finally{
      await listCamerasAfterPermission();
      const preferredId = getPreferredCameraId();
      let idx = preferredId ? devices.findIndex(d => d.deviceId === preferredId) : -1;
      if (idx >= 0) { currentIndex = idx; cameraSel.selectedIndex = idx; }
      if (autostart || preferredId) {
        const devId = devices[currentIndex]?.deviceId || preferredId || null;
        if (devId) start(devId);
      }
    }
  })();
</script>
</body>
</html>
